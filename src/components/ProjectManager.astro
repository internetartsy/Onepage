---
interface Props {
    category: string;
    title: string;
}

const { category, title } = Astro.props;
---

<div class="project-manager" data-category={category}>
    <div class="flex justify-between items-center mb-7 lg:mb-10">
        <h1
            class="text-4xl md:text-5xl lg:text-6xl font-bold text-black dark:text-white"
        >
            {title}
        </h1>
        <div class="flex gap-2">
            <button
                id="toggle-upload"
                class="bg-gray-200 dark:bg-zinc-800 px-4 py-2 rounded hover:bg-gray-300 dark:hover:bg-zinc-700 transition"
            >
                Upload
            </button>
            <button
                id="toggle-delete"
                class="bg-gray-200 dark:bg-zinc-800 px-4 py-2 rounded hover:bg-gray-300 dark:hover:bg-zinc-700 transition"
            >
                Delete
            </button>
        </div>
    </div>

    <!-- Upload Section (Hidden by default) -->
    <div
        id="upload-section"
        class="hidden mb-10 p-6 border border-gray-200 dark:border-zinc-800 rounded-lg bg-gray-50 dark:bg-zinc-900/50"
    >
        <h2 class="text-xl font-bold mb-4">Upload Project</h2>
        <form id="upload-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1"
                    >Image / Embed URL</label
                >
                <input
                    type="url"
                    name="url"
                    required
                    placeholder="https://..."
                    class="w-full p-2 rounded border border-gray-300 dark:border-zinc-700 bg-white dark:bg-zinc-900"
                />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Type</label>
                <select
                    name="type"
                    class="w-full p-2 rounded border border-gray-300 dark:border-zinc-700 bg-white dark:bg-zinc-900"
                >
                    <option value="image">Image</option>
                    <option value="video">Video/Embed</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1"
                    >Note / Description</label
                >
                <textarea
                    name="description"
                    required
                    rows="3"
                    class="w-full p-2 rounded border border-gray-300 dark:border-zinc-700 bg-white dark:bg-zinc-900"
                ></textarea>
            </div>
            <button
                type="submit"
                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition"
            >
                Add Project
            </button>
        </form>
    </div>

    <!-- Delete Section (Hidden by default) -->
    <div
        id="delete-section"
        class="hidden mb-10 p-6 border border-red-200 dark:border-red-900/30 rounded-lg bg-red-50 dark:bg-red-900/10"
    >
        <h2 class="text-xl font-bold mb-4 text-red-600 dark:text-red-400">
            Manage Projects
        </h2>
        <p class="text-sm mb-4">Select projects to delete.</p>
        <div id="delete-list" class="space-y-2">
            <!-- Delete items will be injected here -->
        </div>
    </div>

    <!-- Project Gallery -->
    <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 gap-10">
        <!-- Projects will be injected here -->
        <div class="text-gray-500 italic">Loading projects...</div>
    </div>
</div>

<script>
    // Client-side logic for persistence
    class ProjectManager {
        category: string;
        storageKey: string;
        projects: any[];

        constructor(el: Element) {
            this.category = el.getAttribute("data-category") || "default";
            this.storageKey = `portfolio_projects_${this.category}`;
            this.projects = JSON.parse(
                localStorage.getItem(this.storageKey) || "[]",
            );

            this.initUI(el);
            this.render();
        }

        initUI(el: Element) {
            const uploadBtn = el.querySelector("#toggle-upload");
            const deleteBtn = el.querySelector("#toggle-delete");
            const uploadSection = el.querySelector("#upload-section");
            const deleteSection = el.querySelector("#delete-section");
            const uploadForm = el.querySelector("#upload-form");

            // Toggles
            uploadBtn?.addEventListener("click", () => {
                uploadSection?.classList.toggle("hidden");
                deleteSection?.classList.add("hidden");
            });

            deleteBtn?.addEventListener("click", () => {
                deleteSection?.classList.toggle("hidden");
                uploadSection?.classList.add("hidden");
                this.renderDeleteList(el);
            });

            // Submit
            uploadForm?.addEventListener("submit", (e) => {
                e.preventDefault();
                const formData = new FormData(e.target as HTMLFormElement);
                const newProject = {
                    id: Date.now().toString(),
                    url: formData.get("url"),
                    type: formData.get("type"),
                    description: formData.get("description"),
                    timestamp: new Date().toISOString(),
                };

                this.projects.unshift(newProject);
                this.save();
                this.render();
                (e.target as HTMLFormElement).reset();
                uploadSection?.classList.add("hidden");
            });
        }

        save() {
            localStorage.setItem(
                this.storageKey,
                JSON.stringify(this.projects),
            );
        }

        delete(id: string) {
            this.projects = this.projects.filter((p) => p.id !== id);
            this.save();
            this.render();
            // Re-render delete list if visible, but simple render() handles gallery
            const deleteSection = document.querySelector(
                `div[data-category="${this.category}"] #delete-section`,
            );
            if (!deleteSection?.classList.contains("hidden")) {
                this.renderDeleteList(
                    document.querySelector(
                        `div[data-category="${this.category}"]`,
                    )!,
                );
            }
        }

        render() {
            const gallery = document.querySelector(
                `div[data-category="${this.category}"] #gallery`,
            );
            if (!gallery) return;

            if (this.projects.length === 0) {
                gallery.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">No projects yet. Upload one!</div>`;
                return;
            }

            gallery.innerHTML = this.projects
                .map(
                    (p) => `
        <div class="border border-gray-200 dark:border-zinc-800 p-6 rounded-lg">
          <div class="mb-4 rounded overflow-hidden bg-gray-100 dark:bg-zinc-800 aspect-video flex items-center justify-center">
            ${
                p.type === "video"
                    ? `<iframe src="${p.url}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`
                    : `<img src="${p.url}" alt="Project" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/600x400?text=Invalid+Image'"/>`
            }
          </div>
          <p class="text-gray-600 dark:text-gray-400 whitespace-pre-wrap">${p.description}</p>
        </div>
      `,
                )
                .join("");
        }

        renderDeleteList(container: Element) {
            const list = container.querySelector("#delete-list");
            if (!list) return;

            if (this.projects.length === 0) {
                list.innerHTML =
                    '<div class="text-gray-500">Nothing to delete.</div>';
                return;
            }

            list.innerHTML = this.projects
                .map(
                    (p) => `
        <div class="flex justify-between items-center bg-white dark:bg-zinc-800 p-3 rounded border border-gray-200 dark:border-zinc-700">
          <span class="truncate pr-4">${p.description.substring(0, 50)}...</span>
          <button class="delete-btn text-red-500 hover:text-red-700 font-bold px-2" data-id="${p.id}">
            &times; Remove
          </button>
        </div>
      `,
                )
                .join("");

            // Attach events
            list.querySelectorAll(".delete-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    const id = (e.target as Element).getAttribute("data-id");
                    if (id && confirm("Delete this project?")) {
                        this.delete(id);
                    }
                });
            });
        }
    }

    // Initialize per category
    document.querySelectorAll(".project-manager").forEach((el) => {
        new ProjectManager(el);
    });
</script>
